# WASM Host ABI (Language-Neutral)

Updated: 2026-02-07
Status: Draft v1
Source implementation: `src/wasm/capnp_host_abi.zig`

## Purpose

This document defines a low-level WebAssembly ABI for driving Cap'n Proto
message/RPC logic from any host language/runtime.

Examples of compatible hosts:
- Deno
- Node.js
- Bun
- Rust (`wasmtime`, `wasmer`, `wasmi`)
- Go (`wazero`)
- C/C++ hosts

The ABI is intentionally minimal:
- all exported functions are synchronous,
- all parameters/returns are numeric scalars (`u32`),
- host owns async transport/event loop behavior.

## ABI Versioning

```c
u32 capnp_wasm_abi_version();
```

- Current value: `1`.
- Host must validate this at startup.
- If version mismatches, host should fail fast.

## Types and Conventions

- Integer type: all ABI scalars are unsigned 32-bit (`u32`).
- Boolean return convention:
  - `1` means success/true
  - `0` means false/no-value or failure (check error API when failure is possible)
- Pointer convention:
  - pointers are offsets into wasm linear memory
  - `0` is null
- Length convention:
  - lengths are bytes
  - `(ptr=0, len=0)` is valid for empty buffers

## Memory API

```c
u32 capnp_alloc(u32 len);
void capnp_free(u32 ptr, u32 len);
void capnp_buf_free(u32 ptr, u32 len);
```

Semantics:
- `capnp_alloc(len)` returns a pointer to at least `len` bytes.
- `capnp_alloc(0)` is allowed and returns a non-zero pointer suitable for later
  `capnp_free(ptr, 0)`.
- `capnp_alloc` returns `0` on failure and sets error state.
- `capnp_free`/`capnp_buf_free` are no-ops for `ptr == 0`.
- `capnp_buf_free` is an alias of `capnp_free`.

Ownership:
- Host must free any buffer allocated by `capnp_alloc`.
- For output buffers returned by ABI functions, host must free using
  `capnp_buf_free` (or `capnp_free` if needed).

## Error API

```c
u32 capnp_last_error_code();
u32 capnp_last_error_ptr();
u32 capnp_last_error_len();
void capnp_clear_error();
```

Semantics:
- Error state is process-global per wasm instance.
- Most mutating calls clear previous error state on entry.
- On failure, `capnp_last_error_code() != 0`.
- `capnp_last_error_ptr/len` identify a UTF-8 error message in wasm memory.

Current code values (implementation detail, may expand):
- `1`: alloc error
- `2`: invalid argument
- `3`: unknown peer handle
- `4`: peer create failure
- `5`: peer push failure
- `6`: peer pop failure
- `7`: serde encode failure
- `8`: serde decode failure
- `9`: bootstrap config failure

## RPC Peer API

```c
u32 capnp_peer_new();
void capnp_peer_free(u32 peer);
u32 capnp_peer_push_frame(u32 peer, u32 frame_ptr, u32 frame_len);
u32 capnp_peer_pop_out_frame(u32 peer, u32 out_ptr_ptr, u32 out_len_ptr);
void capnp_peer_pop_commit(u32 peer);
u32 capnp_peer_set_bootstrap_stub(u32 peer); // optional/test hook
```

### `capnp_peer_new`
- Returns non-zero opaque peer handle on success.
- Returns `0` on failure and sets error state.

### `capnp_peer_free`
- Idempotent-style behavior for unknown handles (no failure return).
- Releases peer resources.

### `capnp_peer_push_frame`
- Input is one complete Cap'n Proto RPC frame.
- Returns `1` on success.
- Returns `0` on error and sets error state.

### `capnp_peer_pop_out_frame`
- Polls one outbound frame generated by peer state transitions.
- `out_ptr_ptr` and `out_len_ptr` are pointers to writable `u32` cells in wasm
  memory.
- Returns `1` when a frame is available and writes `(ptr,len)`.
- Returns `0` when queue is empty and writes `(0,0)`.
- Returns `0` on invalid args/failure and sets error state.

Borrow rule:
- Returned outbound frame bytes are borrowed.
- Host should copy bytes before making more ABI calls.
- Host should call `capnp_peer_pop_commit(peer)` after copy to release/advance.

### `capnp_peer_pop_commit`
- Commits/release last popped outbound frame for that peer.
- Safe to call even if no frame is currently borrowed.

### `capnp_peer_set_bootstrap_stub`
- Optional hook primarily for integration tests.
- Installs a default bootstrap export that returns an exception.
- Returns `1` on success, `0` on error.
- Production hosts typically do not need this.

## Required Host Pump Behavior

After every successful `capnp_peer_push_frame`, host must drain outbound frames:

1. Call `capnp_peer_pop_out_frame` in a loop.
2. If return is `1`, copy the `(ptr,len)` bytes, then call
   `capnp_peer_pop_commit`.
3. If return is `0` and `(ptr,len) == (0,0)`, outbound queue is empty.
4. Preserve frame ordering when sending to transport.

One inbound frame may produce multiple outbound frames.

## Serde API Pattern (Schema-Specific)

Generated exports should follow:

```c
u32 capnp_<schema>_<type>_to_json(
  u32 frame_ptr,
  u32 frame_len,
  u32 out_json_ptr_ptr,
  u32 out_json_len_ptr
);

u32 capnp_<schema>_<type>_from_json(
  u32 json_ptr,
  u32 json_len,
  u32 out_frame_ptr_ptr,
  u32 out_frame_len_ptr
);
```

Current live example exports:
- `capnp_example_person_to_json`
- `capnp_example_person_from_json`

Semantics:
- Return `1` on success and write output `(ptr,len)`.
- Return `0` on error and set error state.
- Host frees successful output with `capnp_buf_free`/`capnp_free`.

## Minimal Host Call Pattern

For a typical inbound RPC frame:

1. Allocate wasm input buffer with `capnp_alloc`.
2. Copy inbound bytes into wasm memory.
3. Call `capnp_peer_push_frame`.
4. Loop `capnp_peer_pop_out_frame` and commit each popped frame.
5. Free temporary input buffer.

For any ABI call returning failure:

1. Read `capnp_last_error_code`.
2. Read message bytes from `capnp_last_error_ptr/len`.
3. Map to host-native error type.

## Non-Goals

- Defining host-language bindings in this document.
- Defining transport APIs (TCP/WebSocket/IPC).
- Defining async callback semantics from wasm to host.

Those are host-layer concerns built on top of this ABI.
